# docker-compose.yml - Aider Code Review 服务编排
# 实现代码与镜像分离：代码通过volumes挂载

version: '3.8'

services:
  aider-reviewer:
    image: aider-reviewer:latest
    container_name: aider-code-review
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${SERVER_PORT:-5000}:5000"

    # ============================================
    # 代码与镜像分离的核心配置
    # ============================================
    volumes:
      # 挂载业务代码（实现代码与镜像分离）
      - ./:/app:ro

      # 挂载Aider配置文件
      - ./.aider.conf.yml:/home/reviewer/.aider.conf.yml:ro

      # 临时工作目录（用于克隆和审查代码）
      - aider_workdir:/tmp/aider_reviewer

      # 数据库持久化（存储审查记录）
      - ./data:/app/data

    # 外置配置文件（从.env读取所有环境变量）
    env_file:
      - .env

    # 固定的容器内部配置（不需要外置）
    environment:
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=5000
      - WORK_DIR_BASE=/tmp/aider_reviewer

    restart: unless-stopped

    networks:
      - review_network

    # 资源限制
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

volumes:
  aider_workdir:
    driver: local

networks:
  review_network:
    driver: bridge
