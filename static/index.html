<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aider Code Review - 仪表盘</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- 字体：优先使用本地系统字体，内网环境无需外部CDN -->
    <style>
        @font-face {
            font-family: 'Inter';
            src: local('Inter'), local('PingFang SC'), local('Microsoft YaHei'), local('SimHei');
        }
    </style>
    <!-- Chart.js: 内网环境请下载chart.js到static目录并修改下方路径 -->
    <!-- 本地路径示例: <script src="/static/chart.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">🔍</div>
                <span class="logo-text">Code Review</span>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="overview">
                        <span class="nav-icon">📊</span>
                        <span>概览</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="reviews">
                        <span class="nav-icon">📝</span>
                        <span>审查记录</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="authors">
                        <span class="nav-icon">👥</span>
                        <span>提交人统计</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="projects">
                        <span class="nav-icon">📁</span>
                        <span>项目统计</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="settings">
                        <span class="nav-icon">⚙️</span>
                        <span>系统设置</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 概览页面 -->
            <div id="page-overview" class="page">
                <div class="page-header">
                    <h1 class="page-title">仪表盘概览</h1>
                    <p class="page-subtitle">AI代码审查系统运行状态一览</p>
                </div>

                <!-- 统计卡片 -->
                <div class="stats-grid" id="overview-stats">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon primary">📋</div>
                        </div>
                        <div class="stat-value" id="stat-total">--</div>
                        <div class="stat-label">总审查次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon success">✅</div>
                        </div>
                        <div class="stat-value" id="stat-completed">--</div>
                        <div class="stat-label">已完成审查</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon warning">⚠️</div>
                        </div>
                        <div class="stat-value" id="stat-issues">--</div>
                        <div class="stat-label">发现问题总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon danger">🔴</div>
                        </div>
                        <div class="stat-value" id="stat-critical">--</div>
                        <div class="stat-label">严重问题</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon info">⚡</div>
                        </div>
                        <div class="stat-value" id="stat-avg-time">--</div>
                        <div class="stat-label">平均处理时间(秒)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon success">⭐</div>
                        </div>
                        <div class="stat-value" id="stat-avg-score">--</div>
                        <div class="stat-label">平均质量评分</div>
                    </div>
                </div>

                <!-- 图表 -->
                <div class="chart-grid">
                    <div class="chart-card full-width">
                        <h3 class="chart-title">📈 每日审查趋势</h3>
                        <div class="chart-container">
                            <canvas id="chart-daily-trend"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">📊 审查类型分布</h3>
                        <div class="chart-container">
                            <canvas id="chart-review-type"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">🔴 问题严重程度分布</h3>
                        <div class="chart-container">
                            <canvas id="chart-issue-severity"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 审查记录页面 -->
            <div id="page-reviews" class="page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">审查记录</h1>
                    <p class="page-subtitle">所有代码审查记录列表</p>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">最近审查</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>项目</th>
                                <th>提交人</th>
                                <th>类型</th>
                                <th>状态</th>
                                <th>问题数</th>
                                <th>质量评分</th>
                            </tr>
                        </thead>
                        <tbody id="reviews-table-body">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 提交人统计页面 -->
            <div id="page-authors" class="page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">提交人统计</h1>
                    <p class="page-subtitle">按开发者统计代码质量和提交情况</p>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">开发者排行榜</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>开发者</th>
                                <th>审查次数</th>
                                <th>问题总数</th>
                                <th>严重问题</th>
                                <th>平均评分</th>
                                <th>问题率</th>
                            </tr>
                        </thead>
                        <tbody id="authors-table-body">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 作者活跃度图表 -->
                <div class="chart-grid" style="margin-top: 24px;">
                    <div class="chart-card full-width">
                        <h3 class="chart-title">👥 开发者贡献对比</h3>
                        <div class="chart-container">
                            <canvas id="chart-author-contribution"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 项目统计页面 -->
            <div id="page-projects" class="page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">项目统计</h1>
                    <p class="page-subtitle">按项目统计审查情况</p>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">项目排行榜</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>项目名称</th>
                                <th>平台</th>
                                <th>审查次数</th>
                                <th>问题总数</th>
                                <th>贡献者数</th>
                                <th>平均评分</th>
                            </tr>
                        </thead>
                        <tbody id="projects-table-body">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 系统设置页面 -->
            <div id="page-settings" class="page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">系统设置</h1>
                    <p class="page-subtitle">配置服务参数，保存后立即生效</p>
                </div>

                <form id="settings-form">

                    <!-- vLLM 配置 -->
                    <div class="settings-card">
                        <h3 class="settings-title">🤖 vLLM 模型配置</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label>API地址</label>
                                <input type="text" name="vllm_api_base" class="form-input"
                                    placeholder="http://192.168.1.100:8000/v1">
                            </div>
                            <div class="form-group">
                                <label>API密钥</label>
                                <input type="text" name="vllm_api_key" class="form-input" placeholder="sk-xxx">
                            </div>
                            <div class="form-group full-width">
                                <label>模型名称</label>
                                <input type="text" name="vllm_model_name" class="form-input"
                                    placeholder="openai/qwen-2.5-coder-32b">
                                <small class="form-hint">使用 openai/ 前缀让Aider使用OpenAI协议</small>
                            </div>
                            <div class="form-group full-width">
                                <button type="button" class="btn btn-test" onclick="testVllmConnection()">
                                    🧪 测试模型
                                </button>
                                <span id="vllm-test-result" class="test-result"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Aider 配置 -->
                    <div class="settings-card">
                        <h3 class="settings-title">🔧 Aider 配置</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label>RepoMap Token数</label>
                                <input type="number" name="aider_map_tokens" class="form-input" placeholder="262144">
                                <small class="form-hint">较大值提供更好的上下文</small>
                            </div>
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" name="aider_no_repo_map" class="toggle-input">
                                    <span class="toggle-switch"></span>
                                    <span>禁用 RepoMap</span>
                                </label>
                                <small class="form-hint">显存不足时可开启</small>
                            </div>
                            <div class="form-group full-width">
                                <button type="button" class="btn btn-test" onclick="testAider()">
                                    ✅ 验证 Aider
                                </button>
                                <span id="aider-test-result" class="test-result"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 轮询配置 -->
                    <div class="settings-card">
                        <h3 class="settings-title">🔄 触发模式配置</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label>触发模式</label>
                                <select name="trigger_mode" class="form-input" onchange="togglePollingUI()">
                                    <option value="webhook">Webhook (推送触发)</option>
                                    <option value="polling">轮询 (定时检查)</option>
                                </select>
                                <small class="form-hint">Webhook需要Git平台支持，轮询主动检查仓库</small>
                            </div>
                            <div class="form-group">
                                <label>轮询间隔(分钟)</label>
                                <input type="number" name="polling_interval" class="form-input" placeholder="5" min="1"
                                    max="60">
                            </div>
                        </div>

                        <!-- 轮询仓库管理 -->
                        <div id="polling-repos-section" style="margin-top: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: var(--text-secondary);">📦 监控仓库列表</h4>
                                <button type="button" class="btn btn-test" onclick="showAddRepoModal()">
                                    ➕ 添加仓库
                                </button>
                            </div>
                            <div id="repos-list" class="repos-list">
                                <!-- 仓库列表将通过JS动态渲染 -->
                            </div>
                        </div>

                        <!-- 轮询控制 -->
                        <div class="form-group full-width" style="margin-top: 16px;">
                            <button type="button" class="btn btn-primary" id="polling-toggle-btn"
                                onclick="togglePolling()">
                                ▶️ 启动轮询
                            </button>
                            <span id="polling-status" class="test-result"></span>
                        </div>
                    </div>

                    <div class="settings-actions">
                        <button type="submit" class="btn btn-primary">💾 保存设置</button>
                        <span id="settings-status" class="settings-status"></span>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- 添加仓库模态框 -->
    <div class="modal-overlay" id="add-repo-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">添加监控仓库</h3>
                <button class="modal-close" onclick="closeAddRepoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Git平台和鉴权方式 -->
                <div class="settings-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>Git平台</label>
                        <select id="new-repo-platform" class="form-input" onchange="onPlatformChange()">
                            <option value="gitlab">GitLab</option>
                            <option value="gitea">Gitea</option>
                            <option value="github">GitHub</option>
                        </select>
                        <small class="form-hint">切换后会自动更新API地址</small>
                    </div>
                    <div class="form-group">
                        <label>鉴权方式</label>
                        <select id="new-repo-auth-type" class="form-input" onchange="toggleAuthFields()">
                            <option value="http_basic">用户名/密码</option>
                            <option value="token">API Token</option>
                        </select>
                    </div>
                </div>

                <!-- HTTP认证 (根据鉴权方式显示) -->
                <div id="http-auth-fields" class="settings-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>HTTP用户名</label>
                        <input type="text" id="new-repo-http-user" class="form-input" placeholder="git用户名">
                    </div>
                    <div class="form-group">
                        <label>HTTP密码</label>
                        <input type="password" id="new-repo-http-password" class="form-input" placeholder="git密码">
                    </div>
                </div>

                <!-- Token认证 (根据鉴权方式显示) -->
                <div id="token-auth-fields" class="form-group" style="display: none;">
                    <label>API Token</label>
                    <input type="password" id="new-repo-token" class="form-input" placeholder="Git API Token">
                </div>

                <!-- API地址 (仅启用评论回写时显示) -->
                <div class="form-group" id="api-url-field">
                    <label>API地址</label>
                    <input type="text" id="new-repo-api-url" class="form-input"
                        placeholder="http://code.example.com/api/v4">
                    <small class="form-hint">自动推断，用于回写评论</small>
                </div>

                <!-- 仓库URL -->
                <div class="form-group">
                    <label>仓库URL</label>
                    <input type="text" id="new-repo-url" class="form-input"
                        placeholder="http://code.example.com/group/project.git" oninput="onRepoUrlChange()">
                    <small class="form-hint">输入URL后自动解析仓库名称和加载分支</small>
                </div>

                <!-- 仓库名称 -->
                <div class="form-group">
                    <label>仓库名称</label>
                    <input type="text" id="new-repo-name" class="form-input" placeholder="自动从URL解析">
                </div>

                <!-- 分支选择 -->
                <div class="form-group">
                    <label>监控分支</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="new-repo-branch-select" class="form-input" style="flex: 1;"
                            onchange="updateBranchInput()">
                            <option value="">-- 输入URL后加载分支 --</option>
                        </select>
                        <button type="button" class="btn btn-test" onclick="loadBranches()" id="load-branches-btn">
                            🔄 加载
                        </button>
                    </div>
                    <input type="text" id="new-repo-branch" class="form-input" placeholder="main" value="main"
                        style="margin-top: 8px;">
                </div>

                <!-- 存储路径 -->
                <div class="form-group">
                    <label>本地存储路径</label>
                    <input type="text" id="new-repo-local-path" class="form-input"
                        placeholder="默认: /app/repos/{名称}/{分支}">
                    <small class="form-hint">留空使用默认路径</small>
                </div>

                <!-- 监控配置 -->
                <div class="settings-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="new-repo-commits" class="toggle-input" checked>
                            <span class="toggle-switch"></span>
                            <span>轮询新提交</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="new-repo-mrs" class="toggle-input" checked>
                            <span class="toggle-switch"></span>
                            <span>轮询新MR</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="new-repo-enable-comment" class="toggle-input" checked
                                onchange="toggleApiUrlField()">
                            <span class="toggle-switch"></span>
                            <span>评论回写</span>
                        </label>
                    </div>
                </div>

                <!-- 操作结果 -->
                <div id="add-repo-result" class="test-result" style="margin-top: 12px;"></div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-test" onclick="closeAddRepoModal()">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addRepo()">➕ 添加并克隆</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 审查详情模态框 -->
    <div class="modal-overlay" id="review-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">审查详情</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="review-modal-body">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>

</html>